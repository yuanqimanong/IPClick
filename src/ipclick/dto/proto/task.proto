// python -m grpc_tools.protoc -I. --python_out=. --grpc_python_out=. task.proto
// from . import task_pb2 as task__pb2

syntax = "proto3";

package task;

// =====================================
// 基础枚举定义
// =====================================

// 适配器类型枚举
enum AdapterType {
  CURL_CFFI = 0;
  HTTPX = 1;
  REQUESTS = 2;
  DRISSIONPAGE = 3;
  UC = 4; // undetected-chromedriver
  PLAYWRIGHT = 5;
}

// HTTP 方法枚举
enum HttpMethod {
  GET = 0;
  POST = 1;
  PUT = 2;
  DELETE = 3;
  PATCH = 4;
  HEAD = 5;
  OPTIONS = 6;
  TRACE = 7;
}


// =====================================
// 主要任务消息定义
// =====================================

// 请求消息
message ReqTask {
  string uuid = 1;  // 唯一标识符
  AdapterType adapter = 2;  // 下载适配器

  // 协议
  HttpMethod method = 3;  // 请求方法
  string url = 4;  // 请求 URL
  map<string, string> headers = 5;  // 请求头（键值对）
  map<string, string> cookies = 6;  // 请求 cookies
  string params = 7;  // 查询参数（键值对）
  string data = 8;  // 二进制体
  string json = 9;  // JSON
  string proxy = 10;  // 代理信息
  float timeout_seconds = 11;  // 超时时间（秒）
  int32 max_retries = 12;  // 重试次数
  float retry_backoff_seconds = 13;  // 重试间隔（秒，支持指数退避扩展）
  bool verify_ssl = 14;  // 是否验证 SSL（默认 true）
  bool allow_redirects = 15;  // 是否跟随重定向（默认 true）
  bool stream = 16;  // 是否流式传输（默认 false）

  string impersonate = 17; // curl_cffi专用
  map<string, string> extensions = 18;  // 扩展信息（e.g., "ja3_fingerprint": "value"）

  // 渲染
  string automation_config = 19;  // 自动化框架的配置
  string automation_script = 20;  // 自动化框架的脚本

  repeated int32 allowed_status_codes = 21;  // 重试白名单，如 [200, 404]

  string kwargs = 22; // 其他参数
}

// 响应消息
message TaskResp {
  string request_uuid = 1;
  AdapterType adapter = 2;  // 下载适配器
  ReqTask original_request = 3;  // 原始请求信息
  string effective_url = 4;  // 实际 URL
  int32 status_code = 5;  // 响应状态码
  map<string, string> response_headers = 6;  // 响应头
  bytes content = 7;
  string error_message = 8;  // 错误信息（如果失败）
  int64 response_time_ms = 9;  // 响应时间（毫秒）
}


// =====================================
// 服务定义
// =====================================

service TaskService {
  rpc Send(ReqTask) returns (TaskResp) {}
}